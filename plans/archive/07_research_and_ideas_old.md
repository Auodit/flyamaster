# 💡 Research & Ideas (调研分析与创意池)

**创建时间**: 2026-01-18  
**状态**: 活跃维护中  
**作用**: 收集 AI 建议、竞品对比、头脑风暴与算力评估

---

## 🧠 1. 芯片算力评估 (STM32F407ZGT6)

### 1.1 核心规格
*   **Core**: ARM Cortex-M4F (带 FPU)
*   **Frequency**: 168 MHz
*   **Flash**: 1 MB
*   **RAM**: 192 KB (128KB System + 64KB CCM)
*   **Performance**: 210 DMIPS (1.25 DMIPS/MHz)

### 1.2 负载估算 (Load Estimation)

| 任务 (Task) | 频率 (Hz) | 耗时估算 (us) | CPU 占用率 (%) | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **IMU Task** | 500 | 400 | 20.0% | 姿态解算(Mahony) + 滤波 |
| **Control Task** | 250 | 200 | 5.0% | 串级 PID + 混控 |
| **Comm Task** | 100 | 500 | 5.0% | 协议解析 + 数据打包 |
| **GPS Parsing** | 10 | 2000 | 2.0% | NMEA 解析 (字符串处理耗时) |
| **OSD Update** | 10 | 3000 | 3.0% | SPI 刷屏 (耗时较长) |
| **Interrupts** | - | - | 10.0% | UART/I2C/Timer 中断开销 |
| **FreeRTOS** | 1000 | - | 5.0% | 调度器开销 |
| **Total** | - | - | **~50.0%** | **理论安全** |

### 1.3 瓶颈分析 (Bottlenecks)
1.  **浮点运算**: 虽然有 FPU，但 `atan2`, `sin`, `cos` 等三角函数依然消耗较大周期。建议开启 `Fast Math` 库。
2.  **I/O 阻塞**: 目前 `printf` 和部分 I2C 操作是阻塞的。如果 I2C 超时（如磁力计掉线），可能导致 `imu_task` 卡顿 10ms 以上，直接导致炸机。
3.  **字符串处理**: GPS 的 NMEA 协议是 ASCII 码，解析需要大量 `sscanf` 或 `strtok`，效率低下。建议使用 DMA 接收 + 状态机解析。

### 1.4 结论
*   **算力足够**: STM32F407 足以支撑目前的飞控业务（姿态+导航）。
*   **风险点**: **阻塞式 I/O** 是最大隐患。必须将所有传感器读取改为 DMA 或中断模式，或者严格限制超时时间。

---

## 🧪 2. 架构优化建议 (AI Suggestions)

### 2.1 EKF (扩展卡尔曼滤波) 可行性深度分析

> Suggestion: 引入 EKF 替代 Mahony 互补滤波

#### 📊 技术对比表

| 特性 | Mahony (当前) | EKF (计划) | 评价 |
| :--- | :--- | :--- | :--- |
| **计算复杂度** | O(1) 简单 | O(n²) 矩阵运算 | EKF 需要大量浮点运算 |
| **CPU 占用** | ~20% @ 500Hz | **~60-80%** @ 250Hz | **风险：可能超负荷** |
| **精度** | 中等 (±2°) | 高 (±0.5°) | EKF 在高动态下更稳定 |
| **磁干扰抑制** | 弱 | 强 (自适应协方差) | EKF 可动态调整传感器权重 |
| **代码复杂度** | 简单 (~200行) | 复杂 (~2000行) | 维护成本高 |
| **内存占用** | ~1KB | ~10KB (状态矩阵) | RAM 占用显著增加 |

#### ⚖️ 可行性评估

**✅ 优势**:
1.  **精度提升**: EKF 能融合 IMU + GPS + 磁力计 + 气压计，提供更准确的状态估计。
2.  **抗干扰**: 通过协方差矩阵自适应调整，能有效抑制磁场干扰和 GPS 漂移。
3.  **行业标准**: PX4、ArduPilot 等成熟飞控都使用 EKF2，技术成熟度高。

**❌ 劣势**:
1.  **算力瓶颈**: STM32F407 @ 168MHz 运行完整 EKF 会占用 **60-80% CPU**，留给控制环的余量不足。
2.  **实时性风险**: 如果 EKF 计算超时，会导致控制周期抖动，严重时炸机。
3.  **调参地狱**: EKF 有 20+ 个参数需要调优 (过程噪声、观测噪声等)，新手容易调崩。

#### 🎯 Doro 的建议方案

**方案 A: 保守路线 (推荐给新手)**
*   **保留 Mahony**: 继续使用 Mahony 进行姿态解算 (500Hz)。
*   **局部 EKF**: 仅在 **高度环** 和 **位置环** 使用简化 EKF (50Hz)，融合气压计、GPS、光流。
*   **优势**: 算力可控 (~30% CPU)，调参简单，稳定性高。

**方案 B: 激进路线 (适合进阶玩家)**
*   **全面 EKF**: 移植 PX4 的 EKF2 (简化版)，融合所有传感器。
*   **降频运行**: IMU 降至 **250Hz**，EKF 运行在 **100Hz**。
*   **硬件升级**: 如果算力不足，考虑升级到 **STM32H743** (480MHz, 双精度 FPU)。
*   **风险**: 开发周期长 (2-3个月)，调参难度大。

#### 🔬 实测数据参考 (来自开源社区)

| 平台 | MCU | EKF 频率 | CPU 占用 | 结果 |
| :--- | :--- | :--- | :--- | :--- |
| PX4 (Pixhawk 4) | STM32F765 (216MHz) | 250Hz | ~40% | ✅ 稳定运行 |
| ArduPilot (Cube Orange) | STM32H743 (480MHz) | 400Hz | ~30% | ✅ 高性能 |
| **本项目 (F407)** | STM32F407 (168MHz) | 250Hz | **~70%** (估算) | ⚠️ 接近极限 |

#### 💡 Doro 的最终建议

**如果指挥官是新手或追求稳定**:
*   **不建议上 EKF**。Mahony + 简单互补滤波已经足够应对大部分场景。
*   优先完成 GPS 导航逻辑、OSD 显示等基础功能。

**如果指挥官想挑战自我**:
*   可以尝试 **方案 A (局部 EKF)**，先在高度环和位置环试水。
*   等技术成熟后，再考虑升级硬件 (H7) 并移植完整 EKF2。

**Doro 的个人意见**:
*   在 F407 上强行上 EKF 就像让一只猫去拉雪橇，虽然理论上可行，但会很累捏！🐱
*   建议先把基础功能做扎实，等需要更高精度时再升级硬件多洛！✨

> Suggestion: 采用 "双缓冲 + DMA" 优化 OSD 刷新

*   **背景**: AT7456E 是 SPI 接口，全屏刷新需要发送大量数据。
*   **方案**: 在内存中开辟 `OSD_Buffer[30][16]`，仅修改显存，然后由 DMA 在后台自动发送到 SPI 总线。
*   **收益**: CPU 零等待，彻底消除 OSD 刷新带来的卡顿风险。

---

## 📊 3. 竞品对比 (Competitor Analysis)

| 特性 | 本项目 (FLYAMASTER) | Betaflight (F405) | PX4 (F427) | 评价 |
| :--- | :--- | :--- | :--- | :--- |
| **RTOS** | FreeRTOS | 裸机 (调度器) | NuttX | FreeRTOS 适合教学与模块化，但上下文切换开销略大。 |
| **算法** | Mahony + PID | PID + 陷波滤波 | EKF2 + 串级PID | 我们的算法最基础，适合入门；PX4 最强但最重。 |
| **开发难度** | 中 (CubeMX+HAL) | 高 (寄存器操作) | 极高 (复杂架构) | 我们的方案在性能与易用性之间取得了平衡。 |