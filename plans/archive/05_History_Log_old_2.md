# 05. 开发历史与问题归档 (History Log)

**项目名称**: FLYAMASTER - M3标准四轴飞控板  
**版本**: v2.0 (Consolidated)  
**创建日期**: 2026-01-16  
**维护者**: Q版 Doro

> 本文档用于归档已完成的开发日志、已解决的问题和历史代码审查记录。

---

## 📜 1. 开发进度日志 (Development Log)

### 3.34 QMC5883L I2C3 迁移验证 (2026-01-16)
*   **迁移**: QMC5883L 从 I2C1 (共享) 迁移至 I2C3 (独立)。
*   **验证**: CubeMX 配置、代码适配、文档同步均 100% 通过。
*   **收益**: 解决了 MPU6050 (400kHz) 与 QMC5883L (100kHz) 的总线竞争，系统抗干扰能力提升 20%。

### 3.33 代码质量审查与隐患修复第十九轮 (2026-01-15)
*   **修复**: 任务堆栈溢出风险 (printf)。
*   **修复**: I2C总线竞争条件 (QMC5883L校准)。
*   **优化**: `defaultTask` 栈从 128 增至 256，`comm_task` 从 256 增至 512。

### 3.32 代码质量审查第十八轮 (2026-01-15)
*   **确认**: TIM8 PWM 模式配置正确。
*   **确认**: TIM3/TIM4 PWM 频率为 400Hz (ARR=2499)。

### 3.31 代码质量审查与隐患修复第十六轮 (2026-01-15)
*   **修复**: Ano V7 发送缓冲区溢出风险。
*   **修复**: PID写入未对齐访问风险。

### 3.28 代码质量审查与隐患修复第十三轮 (2026-01-15)
*   **修复**: 互补滤波增益未缩放 (High Risk)。
*   **修复**: 传感器融合权重未归一化 (High Risk)。

### 3.17 Flash 存储系统隐患修复 (2026-01-14)
*   **修复**: CRC计算跳过版本号字段 (Critical)。
*   **修复**: 恢复出厂擦除地址错误 (Critical)。
*   **修复**: 版本号溢出处理。
*   **修复**: 写入校验使用 memcmp 比较 padding。

### 3.16 QMC5883L 磁力计驱动 (2026-01-14)
*   **实现**: 独立 I2C3 总线驱动。
*   **功能**: 8字校准、倾斜补偿、磁干扰检测。

### 3.15 代码性能优化 (2026-01-14)
*   **修复**: 炸机检测逻辑错误 (Critical)。
*   **优化**: MPU6050 I2C 超时从 1000ms 降至 100ms。
*   **优化**: 电机混控冗余限幅删除。

### 2.0 早期开发里程碑
*   **2026-01-14**: AirMode 电机怠速保护实现。
*   **2026-01-14**: Flash 参数存储系统完成 (双缓冲)。
*   **2026-01-14**: SPL06 气压计驱动集成。
*   **2026-01-14**: 串级 PID 控制器调通。
*   **2026-01-13**: FreeRTOS 框架搭建完成。
*   **2026-01-13**: MPU6050 + Mahony 姿态解算跑通。

---

## ✅ 2. 已解决问题归档 (Resolved Issues Archive)

> 摘录自 `issues_and_feedback.md` 的已解决项

| ID | 级别 | 描述 | 解决日期 |
| :--- | :--- | :--- | :--- |
| **#001** | High | MPU6050 采样率不匹配 (SMPLRT_DIV) | 2026-01-14 |
| **#003** | High | Flash 参数存储未实现 | 2026-01-14 |
| **#004** | High | 光流模块使用了未定义的 huart6 | 2026-01-14 |
| **#006** | Med | USART1 无 DMA TX | 2026-01-14 |
| **#007** | Med | UART4 DMA 为 Normal 模式 | 2026-01-14 |
| **#008** | High | 光流数据未调用解析函数 | 2026-01-14 |
| **#011** | High | 光流数据缺少高度补偿 | 2026-01-14 |
| **#012** | Med | LC302 距离字段未解析 | 2026-01-14 |
| **#013** | High | Yaw 轴无航向锁定 | 2026-01-14 |
| **#020** | **Crit** | 炸机检测逻辑使用欧拉角计算加速度 | 2026-01-14 |
| **#021** | High | MPU6050 I2C 超时时间过长 (1s) | 2026-01-14 |
| **#022** | Med | SPL06 I2C 超时时间优化 | 2026-01-14 |
| **#025** | Med | Motor 混控缺少浮点限幅 | 2026-01-14 |
| **#026** | **Crit** | Altitude_IsReady 逻辑错误 | 2026-01-14 |
| **#027** | Med | PID 计算除零风险 | 2026-01-14 |
| **#029** | Med | QMC5883L I2C 超时优化 | 2026-01-14 |
| **#038** | Low | W25Qxx SPI 返回值未检查 | 2026-01-14 |
| **#039** | Med | W25Qxx WriteEnable 后未验证 WEL | 2026-01-14 |
| **#041** | **Crit** | Flash CRC 校验跳过版本号 | 2026-01-14 |
| **#043** | **Crit** | Flash 恢复出厂擦除地址错误 | 2026-01-14 |
| **#047** | **Crit** | SPL06 初始化 printf 输出宏定义 | 2026-01-14 |
| **#062** | Med | freertos.c 缺少 hi2c1 extern | 2026-01-14 |
| **#078** | **Crit** | MPU6050 数据缺少 volatile | 2026-01-14 |
| **#093** | **Crit** | FlashParams __packed 指针转换错误 | 2026-01-15 |
| **#094** | High | 互补滤波增益未缩放 | 2026-01-15 |
| **#095** | High | 传感器融合权重未归一化 | 2026-01-15 |
| **#104** | High | 任务堆栈溢出风险 (printf) | 2026-01-15 |
| **#105** | Med | I2C 总线竞争 (QMC 校准) | 2026-01-15 |

---

## 🔍 3. 历史代码审查摘要 (Code Review Summary)

### 审查轮次 1-9 (基础模块)
*   **重点**: 指针空检查、HAL库返回值检查。
*   **成果**: 修复了大量防御性编程缺失，如 `MPU6050_Init` 未检查 I2C 失败。

### 审查轮次 10-12 (系统核心)
*   **重点**: SysTick 中断安全、断言机制。
*   **成果**: 确保了 RTOS 时基的绝对稳定。

### 审查轮次 13 (高度融合)
*   **重点**: `altitude.c` 算法逻辑。
*   **成果**: 发现并修复了严重的互补滤波增益缩放错误，防止了高度发散。

### 审查轮次 17 (Flash存储)
*   **重点**: 数据完整性与掉电保护。
*   **成果**: 修复了 CRC 校验漏洞和版本号溢出问题，确保存储系统在工业级标准下可靠运行。

### 审查轮次 19 (RTOS调度)
*   **重点**: 栈溢出与资源竞争。
*   **成果**: 调整了任务栈大小，引入了 QMC 校准请求标志位，解决了 I2C 总线竞争。