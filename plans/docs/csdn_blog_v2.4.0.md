# FLYAMASTER 开源飞控 v2.4.0 硬件设计完成 - 从 STM32F405 到专业级飞行仪表盘

> **项目状态**: 硬件设计完成，等待 PCB 打样验证
> **版本**: HW v2.4.0 / FW v2.3.0
> **日期**: 2026-01-23

---

## 📋 目录

1. [项目简介](#1-项目简介)
2. [硬件架构总览](#2-硬件架构总览)
3. [核心功能亮点](#3-核心功能亮点)
4. [电源管理设计](#4-电源管理设计)
5. [PCB 布局约束](#5-pcb-布局约束)
6. [下一步计划](#6-下一步计划)

---

## 1. 项目简介

FLYAMASTER 是一款基于 **STM32F405RGT6** 的开源四轴飞控项目，采用 **FreeRTOS** 实时操作系统，支持多种飞行模式（自稳/定高/定点/返航）。

### 技术栈

| 类别 | 技术选型 |
|:---|:---|
| **MCU** | STM32F405RGT6 (168MHz, 1MB Flash, 192KB RAM) |
| **RTOS** | FreeRTOS CMSIS_V2 |
| **IMU** | MPU6050 (6轴) |
| **气压计** | SPL06-001 |
| **磁力计** | QMC5883L |
| **接收机** | ELRS (CRSF 协议) |
| **OSD** | AT7456E |
| **Flash** | W25Q128 (16MB) |

---

## 2. 硬件架构总览

### 2.1 MCU 选型对比

| 参数 | STM32F407VET6 (旧) | STM32F405RGT6 (新) |
|:---|:---|:---|
| 封装 | LQFP-100 | **LQFP-64** |
| Flash | 512KB | **1MB** |
| GPIO | 82 | **51** |
| 价格 | ~¥35 | **~¥25** |

**选型理由**: F405 封装更小、Flash 更大、价格更低，非常适合小型飞控。

### 2.2 引脚分配总览

```
┌─────────────────────────────────────────────────────────────┐
│                    STM32F405RGT6 引脚分配                    │
├─────────────────────────────────────────────────────────────┤
│ 传感器 (I2C1)                                               │
│   PB6/PB7: MPU6050 + SPL06 + QMC5883L (400kHz)             │
│   PB5: MPU_INT (数据就绪中断)                               │
├─────────────────────────────────────────────────────────────┤
│ 通信接口                                                    │
│   USART1 (PA9/PA10): K210 上位机 / 日志 (921600 baud)      │
│   USART2 (PA2/PA3): GPS 模块 (115200 baud)                 │
│   USART3 (PB10/PB11): ELRS 接收机 (CRSF, 420000 baud)      │
│   UART4 (PC10/PC11): SmartAudio VTX (4800 baud)            │
│   UART5 (PC12/PD2): 光流模块 (115200 baud)                 │
├─────────────────────────────────────────────────────────────┤
│ 电机 PWM (TIM8, 400Hz)                                      │
│   PC6-PC9: MOTOR_1 ~ MOTOR_4                                │
├─────────────────────────────────────────────────────────────┤
│ LED 指示灯 (7 颗)                                           │
│   PC3: LED_SYS (蓝) | PC4: LED_ERR (红)                    │
│   PB0: LED_GPS (绿) | PB1: LED_RX (黄)                     │
│   PB13: LED_MODE (白) | PB14: LED_LOG (橙) | PB15: LED_VTX (青) │
├─────────────────────────────────────────────────────────────┤
│ 其他                                                        │
│   PA8: WS2812 RGB 灯 (TIM1_CH1)                            │
│   PA11/PA12: USB CDC                                        │
│   PB9: USB_DETECT (插入检测)                                │
│   PC0/PC5: 电池电压/电流检测 (ADC)                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 核心功能亮点

### 3.1 CRSF/ELRS 接收机支持 (HW v2.2.0)

**为什么选择 CRSF 协议？**

| 特性 | SBUS | CRSF |
|:---|:---|:---|
| 波特率 | 100kbps | **420kbps** |
| 通信方向 | 单向 | **双向 (支持遥测)** |
| 反相器 | 需要 | **不需要** |
| 校验 | 无 | **CRC8** |

**硬件连接**:
- USART3 (PB10/PB11) 专用于 ELRS 接收机
- DMA1_Stream1 循环接收，Very High 优先级
- 支持遥测回传（电池电压、RSSI、GPS 等）

### 3.2 7 颗 LED 专业级飞行仪表盘 (HW v2.3.0)

> **设计理念**: 一眼即可判断飞控状态

#### 功能分组

| 组别 | 引脚 | 颜色 | 功能 |
|:---|:---|:---|:---|
| **核心系统** | PC3 | 蓝色 | 系统心跳 (1Hz 闪烁=待机, 常亮=已解锁) |
| | PC4 | 红色 | 警告/错误 (慢闪=低电压, 快闪=传感器故障) |
| **导航链路** | PB0 | 绿色 | GPS 状态 (闪烁=搜星, 常亮=3D Fix) |
| | PB1 | 黄色 | 遥控接收 (常亮=正常, 闪烁=RSSI低, 灭=Failsafe) |
| **飞行任务** | PB13 | 白色 | 飞行模式 (灭=自稳, 亮=手动, 闪=返航) |
| | PB14 | 橙色 | 黑匣子 (闪烁=正在写入Flash) |
| | PB15 | 青色 | 图传状态 (亮=PIT Mode) |

#### 电路设计

采用**灌电流接法** (Sink Mode)，低电平点亮：

```
3.3V ──> 限流电阻 ──> LED (+) ──> LED (-) ──> MCU 引脚
```

- 红/黄/橙色 LED: 1kΩ 限流电阻
- 蓝/绿/白/青色 LED: 470-680Ω 限流电阻

### 3.3 USB 插入检测 (HW v2.4.0)

**问题**: 电池供电时，5V 会通过 USB 反灌到电脑，导致 MCU 误判 USB 已连接。

**解决方案**: 从肖特基二极管阳极取信号

```
USB VBUS ──> D3 (SS14) 阳极 ──┬──> D3 阴极 ──> +5V_USB
                              │
                              └──[R: 10kΩ]──> PB9 (USB_DETECT)
```

- PB9 配置为 GPIO Input, Pull-down
- USB 插入时 PB9 为高电平，电池供电时为低电平

---

## 4. 电源管理设计

### 4.1 电源架构

```
电池 (2S-9S, 4.5-40V)
    │
    ├──> DCDC SY8303 ──> 5V/3A ──> LDO RT9193 ──> 3.3V/500mA
    │                      │
    │                      ├──> USB 5V (带反灌保护)
    │                      ├──> 蜂鸣器
    │                      └──> 外设接口
    │
    ├──> 电机 (直接电池供电)
    ├──> 图传 VTX (VBAT)
    └──> ADC 电压检测 (分压 1:11)
```

### 4.2 关键元件

| 类型 | 规格 | 用途 |
|:---|:---|:---|
| DCDC | SY8303 (SOT-23-6) | 5V/3A, 4.5-40V 输入 |
| LDO | RT9193-33 | 3.3V/500mA |
| 肖特基 | SS14 (SMA) | USB 反灌保护 |

---

## 5. PCB 布局约束

### 5.1 传感器隔离

- **磁力计 (QMC5883L)**: 必须远离电机线、大电流回路
- **气压计 (SPL06)**: 避免强光直射和气流直吹

### 5.2 走线规范

| 类型 | 线宽 |
|:---|:---|
| 主电源 (VBAT) | > 30mil |
| 3.3V / 5V | > 20mil |
| 信号线 | 6-8mil |
| USB 差分线 | 90Ω 阻抗控制 |

### 5.3 晶振处理

- 晶振下方**禁止走线**
- 晶振外壳接地
- 负载电容靠近晶振引脚

---

## 6. 下一步计划

- [ ] PCB 打样 (嘉立创)
- [ ] 焊接验证
- [ ] 固件调试
- [ ] 首飞测试

---

## 📎 相关链接

- **GitHub**: [待添加]
- **硬件设计文档**: `08_hardware_design.md`
- **版本日志**: `05_changelog.md`

---

## 📝 Git 提交信息参考

```bash
git add .
git commit -m "feat(hw): FLYAMASTER v2.4.0 硬件设计完成

## 硬件变更 (HW v2.2.0 - v2.4.0)

### HW v2.4.0 - USB Detection Enhancement
- 新增 USB 插入检测引脚 (PB9)
- 从 D3 肖特基二极管阳极取信号
- 解决 USB 反灌误判问题

### HW v2.3.0 - 7-LED Professional Indicator System
- 新增 7 颗状态指示 LED
- 采用灌电流接法 (Sink Mode)

### HW v2.2.0 - UART Refactor & I2C Consolidation
- USART3 用于 ELRS 接收机 (CRSF 协议)
- UART4 专用于 SmartAudio VTX 控制
- 移除 I2C2，所有传感器使用 I2C1

## 固件变更 (FW v2.2.0 - v2.3.0)

### FW v2.3.0 - LED Indicator System
- 新增 led_indicator.c/h 驱动

### FW v2.2.0 - CRSF/ELRS Receiver
- 新增 crsf.c/h 驱动
- 420000 baud, 双向通信

状态: 硬件设计完成，等待 PCB 验证"
```

---

**作者**: Doro  
**日期**: 2026-01-23  
**标签**: STM32, 飞控, 开源硬件, ELRS, CRSF